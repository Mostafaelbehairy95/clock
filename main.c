/*
 * main.c
 *
 * Created: 11/2/2016 8:59:32 AM
 *  Author: elbehairy
 */ 

#define F_CPU 16000000UL
#include <avr/io.h>
#include <util/delay.h>
#include <math.h>


#include "clockdisplay.h"
#include "lcd.h"
#include "RTC.h"
#include "ADC.h"

// Menu Words
char PagesChoose [8][12] = {"1-SetClock","2-SetData","3-SetAlarm","4-StopWatch","5-Pomodoro","6-24/12Mode","7-Exit"};
char weekDay[7][4] = {"Sat","Sun","Mon","Tue","Wed","thu","Fri"};
char PageTime[3][8] = {"Hour:","Minute:","Second:"};
char PageDate[4][9] = {"Day:","Month:","Year:","WeekDay:"};
//??????????????????????????????????????????????????????????????????????????????

//Global Variable
RTC t;
//??????????????????????????????????????????????????????????????????????????????

//Function
void updateTime(int hour,int minute);
void updateDate(int day,int month, int year, int weekDay);
//??????????????????????????????????????????????????????????????????????????????
	
int main(void)
{	int button,displayed = 0;
	// initialization
	lcd4Bit_Init();
	RTC_Init();
	_7Segment_Init();
	uart_init();
	analog_Init();
	//?????????????????????????????????????????????????????????????????????????
	////Set time
	//t.hour = 9; 
	//t.min = 19;
	//t.sec = 00;
	//t.date = 12;
	//t.month = 2;
	//t.year = 19;
	//t.Mode12_24 = 1;
	//t.AmPm = 1;
	//RTC_WriteDataTime(&t);
	//?????????????????????????????????????????????????????????????????????????
	RTC_ReadDataTime(&t);
	lcd4bitInt(t.month);
	lcd4Bitdata('/');
	lcd4bitInt(t.date);
	lcd4Bitdata('/');
	lcd4bitInt(t.year + 2000);
	if(t.AmPm && t.Mode12_24){
		lcd4BitIns(LINE_ONE +14);
		lcd4BitStr("PM");
	}else if(!t.AmPm && t.Mode12_24){
		lcd4BitIns(LINE_ONE +14);	
		lcd4BitStr("AM");
	}
	while(1){
		RTC_ReadDataTime(&t);		
		setClock(t.hour,t.min);
		if(t.AmPm && t.Mode12_24 && t.hour == 12 && t.sec < 50 && t.min < 1){
			lcd4BitIns(LINE_ONE + 14);
			lcd4BitStr("PM");
		}else if(!t.AmPm && t.Mode12_24 && t.hour == 12 && t.sec < 2 && t.min < 1){
			lcd4BitIns(LINE_ONE );
			lcd4bitInt(t.month);
			lcd4Bitdata('/');
			lcd4bitInt(t.date);
			lcd4Bitdata('/');
			lcd4bitInt(t.year + 2000);	
			lcd4BitIns(LINE_ONE + 14);
			lcd4BitStr("AM");			
		}
		button = readAnalog(3);

		if(button >= 0 && button < 10){
			lcd4BitIns(LINE_TWO);
			lcd4BitStr("               ");
			lcd4BitIns(LINE_TWO);
			lcd4BitStr("SetTimeDate");
			displayed = t.sec;	
		}else if(button > 500 && button < 600){
			lcd4BitIns(LINE_TWO);
			lcd4BitStr("               ");
			lcd4BitIns(LINE_TWO);
			lcd4BitStr("StopWatch");
			displayed = t.sec;				
		}else if(button > 600 && button < 720){
			lcd4BitIns(LINE_TWO);
			lcd4BitStr("               ");
			lcd4BitIns(LINE_TWO);
			lcd4BitStr("Alarm");
			displayed = t.sec;	
		}else if(button > 750 && button < 800){
			lcd4BitIns(LINE_TWO);
			lcd4BitStr("               ");
			lcd4BitIns(LINE_TWO);
			lcd4BitStr("Pomodoro");
			displayed = t.sec;	
		}else if(button > 800 && button < 900){
			lcd4BitIns(LINE_TWO);
			lcd4BitStr("               ");			
			lcd4BitIns(LINE_TWO);
			lcd4BitStr("To DO List");	
			displayed = t.sec;	
		}else if(((t.sec >= (displayed + 5) %60 && (displayed > 54) && (t.sec <54) || (t.sec >= displayed + 5) && (displayed <= 54)) && displayed)){
			// Condition for handling disappearance of Selection from lcd after time 5s.
			// Note: if second less 54 i add 5 to displayed variable and wait unit t.sec arrive to displayed + 5
			// or second more than 54, in this case i add 5 to displayed variables and mod result of sum with 60 
			//because not found 60 sec or 61 sec and wait t.sec arrvie to (display + 5) % 60
			 
			lcd4BitIns(LINE_TWO);
			lcd4BitStr("               ");						
			displayed = 0;
		}
		
		
	}

}

